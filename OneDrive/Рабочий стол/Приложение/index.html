<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png" type="image/png">
<meta name="theme-color" content="#34d399">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="PackControl">
<link rel="apple-touch-icon" href="icon-512.png">
  <title>📦 Учёт упаковки</title>
  <style>
  /* ===== Основы ===== */
  
body {
  margin: 0;
  padding: 72px 12px 12px; /* Верхнее значение увеличено */
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background-color: #f1f5f9;
}

  h2 {
    font-size: 22px;
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 20px;
    text-align: center;
  }

  /* ===== Контейнеры ===== */
  .container {
    background-color: #ffffff;
    border-radius: 16px;
    padding: 20px;
    margin: 24px auto;
    max-width: 600px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  /* ===== Формы ===== */
  label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-top: 16px;
    margin-bottom: 6px;
    font-size: 15px;
  }

  input, select, textarea {
    width: 100%;
    padding: 12px;
    font-size: 15px;
    border: 1px solid #d1d5db;
    border-radius: 10px;
    background: #f9fafb;
    color: #111827;
    margin-bottom: 16px;
    box-sizing: border-box;
    transition: border 0.2s ease, box-shadow 0.2s ease;
  }

  input:focus, select:focus, textarea:focus {
    border-color: #2563eb;
    background-color: #ffffff;
    outline: none;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
  }

  /* ===== Кнопки ===== */
  button {
    background-color: #2563eb;
    color: white;
    padding: 14px 18px;
    font-size: 15px;
    font-weight: 600;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    width: 100%;
    margin-top: 12px;
    transition: background 0.2s ease, transform 0.1s ease;
  }

  button:hover {
    background-color: #1d4ed8;
  }

  button:active {
    transform: scale(0.97);
  }

  button.danger {
    background-color: #dc2626;
  }

  button.danger:hover {
    background-color: #b91c1c;
  }

.top-nav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-around; /* распределяет кнопки равномерно */
  background-color: #2563eb;
  padding: 10px 0;
  border-bottom-left-radius: 12px;
  border-bottom-right-radius: 12px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  z-index: 1000;
}

  .top-nav button {
  background: none;
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  flex: 1; /* заставляет кнопки растягиваться равномерно */
  text-align: center;
}

  .mobile-nav button:active {
    transform: scale(0.94);
  }

  .mobile-nav button.active {
    background: #1e40af;
    color: white;
  }

  /* ===== Карточки статистики ===== */
  .stat-card {
  background-color: #ffffff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  padding: 16px;
  margin-top: 16px;
  font-size: 15px;
  color: #1f2937;
}

  .stat-card p {
    margin: 6px 0;
  }

  .stat-card button {
    margin-top: 12px;
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background-color: #2563eb;
    color: white;
  }

  .stat-card button:hover {
    background-color: #1d4ed8;
  }

  /* ===== Информация по ставке и расчётам ===== */
  #rateInfo, #calcBlock {
    margin-top: 16px;
    padding: 16px;
    border-radius: 12px;
    background-color: #f3f4f6;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    font-size: 15px;
    color: #1f2937;
  }

  #rateInfo p, #calcBlock p {
    margin: 8px 0;
    display: flex;
    justify-content: space-between;
    font-weight: 500;
  }

  #rateInfo strong, #calcBlock strong {
    color: #111827;
  }

  /* ===== Общая эффективность ===== */
  #totalWage {
    font-size: 16px;
    margin-top: 16px;
    background: #ecfdf5;
    padding: 12px;
    border-radius: 10px;
    text-align: center;
    color: #065f46;
    font-weight: 600;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
  }

  /* ===== Модальное окно редактирования ===== */
  #editModal {
    max-width: 480px;
    background-color: white;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    padding: 24px;
    font-size: 15px;
    color: #1f2937;
  }

  #editModal label {
    display: block;
    margin-top: 12px;
    font-weight: 500;
  }

  #editModal select, #editModal input {
    width: 100%;
    padding: 8px;
    margin-top: 4px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    font-size: 15px;
  }

  #editModal button {
    margin-top: 16px;
    padding: 10px 16px;
    border: none;
    border-radius: 10px;
    background-color: #2563eb;
    color: white;
    font-weight: 600;
    cursor: pointer;
  }

  #editModal button:hover {
    background-color: #1d4ed8;
  }

  #editModal button.danger {
    background-color: #dc2626;
    margin-left: 12px;
  }

  #editModal button.danger:hover {
    background-color: #b91c1c;
  }

  /* ===== Tooltip (всплывающая подсказка) ===== */
  .tooltip[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    background-color: #1f2937;
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 13px;
    white-space: nowrap;
    top: 100%;
    left: 0;
    margin-top: 6px;
    z-index: 10;
  }
#ratesTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

#ratesTable th, #ratesTable td {
  padding: 12px 14px;
  text-align: left;
  font-size: 14px;
}

#ratesTable th {
  background-color: #f3f4f6;
  color: #374151;
  font-weight: 600;
}

#ratesTable tr:nth-child(even) td {
  background-color: #f9fafb;
}

#ratesTable tr:hover td {
  background-color: #eef2ff;
}
#adminContainer {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-top: 20px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.04);
}

#adminContainer h3 {
  font-size: 18px;
  margin-bottom: 12px;
  color: #1f2937;
  font-weight: 600;
}

#adminContainer input[type="text"],
#adminContainer select {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  font-size: 15px;
  background: #f9fafb;
}

#adminContainer button {
  margin-top: 12px;
}
@media (max-width: 500px) {
  .container, #editModal {
    padding: 16px;
    border-radius: 12px;
  }

  #ratesTable th, #ratesTable td {
    padding: 10px 12px;
  }

  button {
    font-size: 14px;
    padding: 12px;
  }

  h2 {
    font-size: 20px;
  }
}
@media (max-width: 500px) {
  #adminContainer label {
    flex: 1 1 100%;
  }

  #adminContainer input[type="date"] {
    font-size: 16px;
  }
}
#appContainer.fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: white;
  z-index: 1000;
  overflow-y: auto;
  padding: 20px;
}
/* Фиксированная нижняя панель с кнопкой */
#saveBar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  padding: 12px;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.08);
  z-index: 1100;
}

#saveBar button {
  width: 100%;
  font-size: 16px;
}
@media (max-width: 500px) {
  #appContainer form > div[style*="display: flex"] {
    flex-direction: column !important;
  }
}
  </style>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png" type="image/png">
<meta name="theme-color" content="#34d399">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="PackControl">
<link rel="apple-touch-icon" href="icon-512.png">
</head>
<body>
<body>
  <nav id="bottomNav" class="top-nav" style="display: none;">
    <button id="tabProfile" onclick="switchTab('profile')">👤</button>
    <button id="tabApp" onclick="switchTab('app')" disabled>📋</button>
    <button id="tabStats" onclick="switchTab('stats')">📈</button>
    <button id="tabRates" onclick="switchTab('rates')">💰</button>
    <button id="tabMySalary" onclick="switchTab('mySalary')">💵</button>
    <button id="tabAdmin" onclick="switchTab('admin')" style="display: none;">🛠️</button>
  </nav>
<div class="container" id="loginContainer">
  <h2>🔐 Вход в систему</h2>
  <label for="login">Имя пользователя</label>
  <input type="text" id="login" placeholder="Введите имя" required>

  <label for="password">Пароль</label>
  <input type="password" id="password" placeholder="•••••••" required>

  <button onclick="handleLogin()">Войти</button>
  <div id="loginError"></div>
</div>
<div class="container" style="display:none;" id="tabContainer">
</div>
<div class="container" style="display:none;" id="appContainer">
  <h2 id="mainTitle">📦 Учёт упаковки</h2>
  <form id="dataForm" style="padding-bottom: 100px;">
    <div class="tooltip" data-tooltip="Поле заполняется автоматически при входе">
      <label>Имя сотрудника:
        <input name="employeeName" required readonly />
      </label>
    </div>

    <!-- Количество и номер заказа -->
    <div style="display: flex; gap: 10px; align-items: flex-end;">
      <div style="flex: 1;">
        <label>Количество:
          <input name="quantity" type="number" required />
        </label>
      </div>
      <div style="flex: 1;">
        <label>Номер заказа:
          <input name="orderNumber" required />
        </label>
      </div>
    </div>

    <!-- Время -->
    <div style="display: flex; gap: 10px; align-items: flex-end;">
      <div style="flex: 1;">
        <label>Время начала:
          <input name="startTime" type="time" required />
        </label>
      </div>
      <div style="flex: 1;">
        <label>Время окончания:
          <input name="endTime" type="time" required />
        </label>
      </div>
    </div>

    <label>Продолжительность:
      <input name="duration" readonly />
    </label>

    <!-- Операция, артикул, объём -->
    <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
      <div style="flex: 1;">
        <label>Операция:
          <select name="operationType" required onchange="handleOperationChange(this.value)"></select>
        </label>
      </div>
      <div style="flex: 1; display: none;" id="setNumberField">
        <label>Артикул набора:
          <select name="setNumber"></select>
        </label>
      </div>
      <div style="flex: 1;" id="volumeLabel">
        <label>Объём:
          <select name="volume" required></select>
        </label>
      </div>
    </div>

    <div id="rateInfo" style="margin-top:16px; background:#f0f0f0; padding:10px; border-radius:8px; display:none;">
      <p><strong>⏱ Норма в час:</strong> <span id="normDisplay">-</span></p>
      <p><strong>💰 Тариф за 1 шт:</strong> <span id="rateDisplay">-</span></p>
    </div>

    <div id="calcBlock" style="margin-top:16px; background:#e7f5ff; padding:10px; border-radius:8px; display:none;">
      <p><strong>💸 Расчёт оплаты:</strong> <span id="wageDisplay">-</span></p>
      <p><strong>⚙️ Эффективность:</strong> <span id="efficiencyDisplay">-</span></p>
    </div>

    <button type="submit">📀 Сохранить</button>
  </form>
  <p id="result" style="display:none;"></p>
</div>
<div class="container" style="display:none;" id="statsContainer">
  <h2>📈 Статистика</h2>
<button onclick="closeStats()" style="margin-bottom: 10px;">❌ Закрыть статистику</button>
  <label>Выбрать дату:<input type="date" id="statsDate"></label>
  <div style="margin-top: 12px;">
  <label>Фильтр по операции:
    <select id="operationFilter">
      <option value="">-- Все операции --</option>
    </select>
  </label>
  <button id="showStatsBtn" onclick="loadStats()">📊 Показать статистику</button>
</div>
  <div id="statsCards"></div>
<div id="statsLogs" style="margin-top: 16px;"></div>
<p id="totalWage" style="text-align:center; font-weight:bold; margin-top:16px;"></p>
</div>
<div class="container" style="display:none;" id="profileContainer">
  <h2>👤 Личный профиль</h2>


  <label>Тип смены:
    <select id="shiftType">
      <option value="">-- Выберите смену --</option>
      <option>День</option>
      <option>Ночь</option>
    </select>
  </label>

  <label>Статус сотрудника:
    <select id="employeeStatus">
      <option value="">-- Выберите статус --</option>
      <option>Штат</option>
      <option>Аутсорсинг</option>
      <option>Стажёр</option>
    </select>
  </label>

  <button onclick="saveProfile()">💾 Сохранить</button>
<p id="profileSaved" style="color:green; text-align:center; display:none;">✅ Сохранено</p>
<p id="profileHint" style="color:#dc2626; font-size:14px; text-align:center; margin-top:12px;">
  ⚠️ Укажите тип смены и статус, затем нажмите «Сохранить», чтобы разблокировать вкладку "Учёт".
</p>
<button id="logoutBtn" onclick="handleLogout()" class="danger">🚪 Выйти</button>
</div>
<div class="container" style="display:none;" id="ratesContainer">
  <h2>💰 Тарифы и нормативы</h2>
  <!-- 🎯 ФИЛЬТРЫ -->
  <div id="ratesFilters" style="display: flex; gap: 10px; margin: 16px 0;">
    <select id="filterOperation" style="flex:1; padding: 10px; font-size: 16px;">
      <option value="">-- Все операции --</option>
    </select>
    <select id="filterKey" style="flex:1; padding: 10px; font-size: 16px;">
      <option value="">-- Все объёмы / артикулы --</option>
    </select>
</div>
  <!-- 📋 СПИСОК ТАРИФОВ -->
  <div id="ratesTable"></div>
</div>
  <!-- Таблица будет добавлена через JS -->
</div>
<!-- 📦 Контейнер: Админ-панель -->
<div class="container" id="adminContainer" style="display:none;">
  <h2>🛠️ Админ-панель</h2>

<!-- 📅 Универсальный период -->
<div style="margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 10px;">
  <label style="flex:1 1 200px;">Период с:
    <input type="date" id="unifiedStart">
  </label>
  <label style="flex:1 1 200px;">по:
    <input type="date" id="unifiedEnd">
  </label>
</div>

  <!-- 🔘 Действия -->
  <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px;">
    <button onclick="loadShiftStats()">📊 Сводка по сменам</button>
    <button onclick="analyzePackers()" id="analyzeBtn">🧮 Анализ упаковщиков</button>
    <button onclick="manualExport()" id="exportBtn">💾 Экспорт</button>
    <button onclick="runCustomReport()" id="reportBtn">📆 Отчёт за период</button>
  </div>

  <!-- 📊 Результаты анализа -->
  <div id="shiftStatsOutput" style="margin-top:20px;"></div>
  <div id="packerAnalysis" style="margin-top:24px;"></div>
</div>

<!-- 💵 Моя зарплата — перемещён ВНЕ adminContainer -->
<div class="container" style="display:none;" id="mySalaryContainer">
  <h2>💵 Моя зарплата</h2>
  <label>📅 Период с:
    <input type="date" id="salaryStart">
  </label>
  <label style="margin-left:10px;">по:
    <input type="date" id="salaryEnd">
  </label>
  <button id="mySalaryBtn" onclick="loadMySalary()">📊 Показать</button>
  <div id="mySalaryOutput" style="margin-top:20px;"></div>
<p id="totalQty" style="text-align:center; font-weight:bold; margin-top:16px;"></p>
</div>
<script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbzMZEDeGvhgx0p7CA-1n2rW6Wtxq-s6seYxFubma7zxdjBfAjAVLSPnPGmB0ovmW9s/exec";
  let todayRecords = [];
  let currentUser = "";
let currentShift = "";
let currentStatus = "";
 let allRates = [];
let currentUserRole = "user"; // ← добавляем сюда

function saveProfile() {
  const shiftSelect = document.getElementById("shiftType");
  const statusSelect = document.getElementById("employeeStatus");

  const shiftValue = shiftSelect.value;
  const statusValue = statusSelect.value;

  // Обновляем глобальные переменные
  currentShift = shiftValue;
  currentStatus = statusValue;

  const isFilled = shiftValue && statusValue;

  const hint = document.getElementById("profileHint");
  const msg = document.getElementById("profileSaved");
  const tabApp = document.getElementById("tabApp");

  // Отображение подсказок
  hint.style.display = isFilled ? "none" : "block";
  msg.style.display = isFilled ? "block" : "none";
  tabApp.disabled = !isFilled;
  tabApp.innerHTML = isFilled ? "📋" : "🔒";

  // Скрываем уведомление об успешном сохранении через 2 секунды
  if (isFilled) {
    setTimeout(() => msg.style.display = "none", 2000);
  }
}

function switchTab(tabName) {
  // Скрываем все контейнеры
  document.getElementById("profileContainer").style.display = "none";
  document.getElementById("appContainer").style.display = "none";
  document.getElementById("statsContainer").style.display = "none";
  document.getElementById("adminContainer").style.display = "none";
  document.getElementById("mySalaryContainer").style.display = "none";
  document.getElementById("ratesContainer").style.display = "none";

  // Удаляем fullscreen от appContainer, если был ранее
  document.getElementById("appContainer").classList.remove("fullscreen");

  // Деактивируем все вкладки
  const tabButtons = ["tabProfile", "tabApp", "tabStats", "tabRates", "tabMySalary", "tabAdmin"];
  tabButtons.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.disabled = false;
  });

  // Активируем нужную вкладку
  switch (tabName) {
    case "profile":
      document.getElementById("profileContainer").style.display = "block";
      document.getElementById("tabProfile").disabled = true;
      break;

    case "app":
      document.getElementById("appContainer").style.display = "block";
      // УБРАНО: document.getElementById("appContainer").classList.add("fullscreen");
      document.getElementById("tabApp").disabled = true;
      break;

    case "stats":
      document.getElementById("statsContainer").style.display = "block";
      document.getElementById("tabStats").disabled = true;
      break;

    case "rates":
      document.getElementById("ratesContainer").style.display = "block";
      document.getElementById("tabRates").disabled = true;
      break;

    case "mySalary":
      document.getElementById("mySalaryContainer").style.display = "block";
      document.getElementById("tabMySalary").disabled = true;
      break;

    case "admin":
      document.getElementById("adminContainer").style.display = "block";
      document.getElementById("tabAdmin").disabled = true;
      break;
  }
}




async function handleLogin() {
  console.log("🔐 handleLogin() вызван");

  const login = document.getElementById("login").value.trim();
  const password = document.getElementById("password").value.trim();
  const errorElem = document.getElementById("loginError");
  errorElem.textContent = ""; // 🧼 Сброс старой ошибки

  try {
    const res = await fetch(`${scriptURL}?type=auth&login=${encodeURIComponent(login)}&password=${encodeURIComponent(password)}`);
    const data = await res.json();

    if (data.status === "ok") {
      currentUser = login;
      currentUserRole = data.role || 'user';

      localStorage.setItem("currentUser", login);
      localStorage.setItem("currentUserRole", currentUserRole);

      // Показ/скрытие админской кнопки
      const tabAdmin = document.getElementById("tabAdmin");
      if (currentUserRole === "admin") {
        tabAdmin.style.display = "block";
      } else {
        tabAdmin.style.display = "none";
      }

      // Скрываем контейнеры перед переходом
      ["appContainer", "statsContainer", "profileContainer", "ratesContainer", "adminContainer", "mySalaryContainer"]
        .forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = "none";
        });

      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("tabContainer").style.display = "block";
      document.querySelector('[name="employeeName"]').value = currentUser;
      document.getElementById("bottomNav").style.display = "flex";

      // Закрытие модалки, если осталась
      const modal = document.getElementById("editModal");
      if (modal) modal.style.display = "none";

      await Promise.all([
        loadVolumes(),
        loadOperations(),
        loadSetNumbers(),
        loadTodayRecords(),
        loadOperationFilter(),
        loadRatesTable()
      ]);

      document.getElementById("operationFilter").addEventListener("change", loadStats);

      // 👉 Открываем только нужную вкладку
      switchTab("profile");

    } else {
      errorElem.textContent = "❌ Неверный логин или PIN-код";
    }
  } catch {
    errorElem.textContent = "❌ Ошибка подключения";
  }
}


function handleLogout() {
  // 🔄 Сброс состояния
  currentUser = "";
  currentUserRole = "user";
  currentShift = "";
  currentStatus = "";

  localStorage.removeItem("currentUser");
  localStorage.removeItem("currentUserRole");

  // 🔐 Очистка формы входа
  const loginInput = document.getElementById("login");
  const passwordInput = document.getElementById("password");
  loginInput.value = "";
  passwordInput.value = "";
  loginInput.focus();

  // 👤 Очистка профиля
  document.querySelector('[name="employeeName"]').value = "";
  document.getElementById("shiftType").value = "";
  document.getElementById("employeeStatus").value = "";
  document.getElementById("profileSaved").style.display = "none";
  document.getElementById("profileHint").style.display = "block";

  // 🔒 Отключение кнопки учёта
  const tabApp = document.getElementById("tabApp");
  tabApp.disabled = true;
  tabApp.innerHTML = "🔒";

  // ❌ Очистка статистики
  closeStats(); // очищает statsCards, totalWage и statsLogs

  // 📉 Очистка полей фильтра статистики
  document.getElementById("operationFilter").value = "";
  document.getElementById("statsDate").value = "";

  // 💵 Очистка зарплатных данных
  document.getElementById("mySalaryOutput").innerHTML = "";
  document.getElementById("totalQty").textContent = "";
  document.getElementById("salaryStart").value = "";
  document.getElementById("salaryEnd").value = "";

  // 🧼 Скрытие всех контейнеров
  const containers = [
    "loginContainer",
    "tabContainer",
    "appContainer",
    "statsContainer",
    "profileContainer",
    "ratesContainer",
    "adminContainer",
    "mySalaryContainer"
  ];
  containers.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = (id === "loginContainer") ? "block" : "none";
  });

  // 🧽 Сброс модальных окон
  const modal = document.getElementById("editModal");
  if (modal) modal.style.display = "none";

  // 👇 Скрытие нижнего меню
  const nav = document.getElementById("bottomNav");
  nav.style.opacity = "0";
  setTimeout(() => {
    nav.style.display = "none";
    nav.style.opacity = "1";
  }, 200);
}

  async function loadTodayRecords() {
    const res = await fetch(`${scriptURL}?type=records`);
    const data = await res.json();
    todayRecords = data.records || [];
  }

function loadMySalary() {
  withLoading("mySalaryBtn", async () => {
    const employee = localStorage.getItem("currentUser") || "";
    const start = document.getElementById("salaryStart").value;
    const end = document.getElementById("salaryEnd").value;

    if (!employee || !start || !end) {
      alert("⚠️ Укажите все поля");
      return;
    }

    try {
      const res = await fetch(`${scriptURL}?type=mySalary&employee=${encodeURIComponent(employee)}&start=${start}&end=${end}`);
      const data = await res.json();

      const container = document.getElementById("mySalaryOutput");
      const totalQtyBlock = document.getElementById("totalQty");

      if (!data.records || data.records.length === 0) {
        container.innerHTML = "<p style='text-align:center;'>Нет данных за выбранный период.</p>";
        totalQtyBlock.textContent = "";
        return;
      }

      let totalQty = 0;
      let totalWage = 0;
      let html = "";

      data.records.forEach(r => {
        totalQty += r.quantity || 0;
        totalWage += r.wage || 0;

        html += `
          <div class="salary-card">
            <p><strong>📅 Дата:</strong> ${formatDate(r.date)}</p>
            <p><strong>🔢 Кол-во:</strong> ${r.quantity}</p>
            <p><strong>⚙️ Эффективность:</strong> ${r.efficiency ?? "-"}%</p>
            <p><strong>💰 Зарплата:</strong> ${(r.wage ?? 0).toFixed(2)} ₽</p>
          </div>
        `;
      });

      container.innerHTML = html;
      totalQtyBlock.textContent = `📦 Всего обработано: ${totalQty} шт. | 💵 Общая сумма: ${totalWage.toFixed(2)} ₽`;
    } catch (err) {
      alert("❌ Ошибка загрузки: " + err.message);
    }
  });
}

// Добавь эту вспомогательную функцию рядом:
function formatDate(isoString) {
  const parts = isoString.split("-");
  return `${parts[2]}.${parts[1]}.${parts[0]}`;
}

  async function loadVolumes() {
    const res = await fetch(`${scriptURL}?type=volumes`);
    const data = await res.json();
    const select = document.querySelector('[name="volume"]');
    select.innerHTML = '<option value="">-- Выбери объём --</option>';
    data.volumes.forEach(val => {
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      select.appendChild(opt);
    });
  }

  async function loadOperations() {
    const res = await fetch(`${scriptURL}?type=operations`);
    const data = await res.json();
    const select = document.querySelector('[name="operationType"]');
    select.innerHTML = '<option value="">-- Выбери операцию --</option>';
    data.operations.forEach(val => {
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      select.appendChild(opt);
    });
    select.addEventListener("change", () => handleOperationChange(select.value));
  }

  async function loadSetNumbers() {
    const res = await fetch(`${scriptURL}?type=sets`);
    const data = await res.json();
    const select = document.querySelector('[name="setNumber"]');
    select.innerHTML = '<option value="">-- Выбери артикул --</option>';
    data.sets.forEach(val => {
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      select.appendChild(opt);
    });
  }

async function deleteRecord(index) {
  if (!confirm("Удалить эту запись?")) return;

  const res = await fetch(`${scriptURL}?type=deleteRecord&index=${index}`);
  const data = await res.json();

  alert(data.message || "Удалено");
  if (data.status === "success") {
    loadStats();
  }
}

  function handleOperationChange(operation) {
  const setField = document.getElementById("setNumberField");
  const volumeLabel = document.getElementById("volumeLabel");
  const volumeSelect = document.querySelector('[name="volume"]');
  const setSelect = document.querySelector('[name="setNumber"]');

  if (operation === 'Сборка "Набора"') {
    setField.style.display = "block";
    setSelect.required = true;
    volumeLabel.style.display = "none";
    volumeSelect.required = false;
    volumeSelect.value = "";
  } else {
    setField.style.display = "none";
    setSelect.required = false;
    setSelect.value = "";
    volumeLabel.style.display = "block";
    volumeSelect.required = true;
  }
}

function updateRateDisplay() {
  const operationType = document.querySelector('[name="operationType"]').value;
  const volume = document.querySelector('[name="volume"]').value;
  const setNumber = document.querySelector('[name="setNumber"]').value;
  const quantity = Number(document.querySelector('[name="quantity"]').value) || 0;

  const startTime = document.querySelector('[name="startTime"]').value;
  const endTime = document.querySelector('[name="endTime"]').value;

  const key = (operationType.includes("Сборка")) ? setNumber : volume;

  const matched = allRates.find(r => r.operation === operationType && r.key === key);

  const block = document.getElementById("rateInfo");
  const norm = document.getElementById("normDisplay");
  const rate = document.getElementById("rateDisplay");

  const calcBlock = document.getElementById("calcBlock");
  const wageDisplay = document.getElementById("wageDisplay");
  const efficiencyDisplay = document.getElementById("efficiencyDisplay");

  if (matched) {
    norm.textContent = matched.normPerHour;
    rate.textContent = matched.ratePerUnit.toFixed(2) + " ₽";

    const totalPay = quantity * matched.ratePerUnit;

    let durationMin = 0;
    if (startTime && endTime) {
      const [sh, sm] = startTime.split(":").map(Number);
      const [eh, em] = endTime.split(":").map(Number);
      durationMin = (eh * 60 + em) - (sh * 60 + sm);
      if (durationMin < 0) durationMin += 1440;
    }

    let efficiency = "-";
    if (durationMin > 0 && matched.normPerHour > 0) {
      const expected = (matched.normPerHour / 60) * durationMin;
      efficiency = ((quantity / expected) * 100).toFixed(0) + " %";
    }

    wageDisplay.textContent = totalPay.toFixed(2) + " ₽";
    efficiencyDisplay.textContent = efficiency;

    block.style.display = "block";
    calcBlock.style.display = "block";
  } else {
    norm.textContent = "-";
    rate.textContent = "-";
    block.style.display = "none";
    calcBlock.style.display = "none";
  }
}
document.querySelector('[name="operationType"]').addEventListener("change", updateRateDisplay);
document.querySelector('[name="volume"]').addEventListener("change", updateRateDisplay);
document.querySelector('[name="setNumber"]').addEventListener("change", updateRateDisplay);
document.querySelector('[name="quantity"]').addEventListener("input", updateRateDisplay);
document.querySelector('[name="startTime"]').addEventListener("change", updateRateDisplay);
document.querySelector('[name="endTime"]').addEventListener("change", updateRateDisplay);

  document.getElementById("dataForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const result = document.getElementById("result");
    await loadTodayRecords();

    const start = formData.get("startTime");
    const end = formData.get("endTime");
    if (start && end) {
      const [sh, sm] = start.split(":" ).map(Number);
      const [eh, em] = end.split(":" ).map(Number);
      let minutes = (eh * 60 + em) - (sh * 60 + sm);
      if (minutes < 0) minutes += 1440;
      const duration = `${Math.floor(minutes / 60)} ч ${minutes % 60} мин`;
      formData.set("duration", duration);
      document.querySelector('[name="duration"]').value = duration;
}
formData.append("shiftType", currentShift);
formData.append("employeeStatus", currentStatus);
   

    const payload = {
  employeeName: formData.get("employeeName")?.trim(),
  quantity: formData.get("quantity")?.trim(),
  startTime: formData.get("startTime")?.trim(),
  endTime: formData.get("endTime")?.trim(),
  volume: formData.get("volume")?.trim(),
  operationType: formData.get("operationType")?.trim(),
  orderNumber: formData.get("orderNumber")?.trim(),
  setNumber: formData.get("setNumber")?.trim(),
  shiftType: currentShift,
  employeeStatus: currentStatus
};

    const isDuplicate = todayRecords.some(rec => {
  const isSame =
    rec.employeeName === payload.employeeName &&
    rec.quantity === payload.quantity &&
    rec.startTime === payload.startTime &&
    rec.endTime === payload.endTime &&
    rec.operationType === payload.operationType &&
    rec.orderNumber === payload.orderNumber &&
    rec.setNumber === payload.setNumber;

  if (!isSame) return false;

  // для операций кроме "Сборка Набора" сравниваем объём
  if (payload.operationType !== 'Сборка "Набора"') {
    return rec.volume === payload.volume;
  }

  return true;
});

    if (isDuplicate) {
  result.textContent = "⚠️ Такая запись уже существует (локальная проверка)";
  result.style.display = "block";

  // сбросить форму
  form.reset();
  document.querySelector('[name="employeeName"]').value = currentUser;
  handleOperationChange("");
  updateRateDisplay();
  return;
}

    try {
      const response = await fetch(scriptURL, {
        method: "POST",
        body: formData
      });
      const resultData = await response.json();
      result.textContent = resultData.message;
      result.style.display = "block";

      if (resultData.status === "success") {
  form.reset();
  document.querySelector('[name="employeeName"]').value = currentUser;
  handleOperationChange("");
  updateRateDisplay();
  await loadTodayRecords();
}
    } catch (error) {
      result.textContent = "❌ Ошибка отправки: " + error.message;
      result.style.display = "block";
    }
  });

async function loadRatesTable() {
  const res = await fetch(`${scriptURL}?type=rates`);
  const data = await res.json();
  allRates = data.rates || [];

  const opFilter = document.getElementById("filterOperation");
  const keyFilter = document.getElementById("filterKey");
  const container = document.getElementById("ratesTable");

  // Очистка фильтров
  opFilter.innerHTML = '<option value="">-- Все операции --</option>';
  keyFilter.innerHTML = '<option value="">-- Все объёмы / артикулы --</option>';

  const operations = [...new Set(allRates.map(r => r.operation))];
  const keys = [...new Set(allRates.map(r => r.key))];

  operations.forEach(op => {
    const opt = document.createElement("option");
    opt.value = op;
    opt.textContent = op;
    opFilter.appendChild(opt);
  });

  keys.forEach(k => {
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = k;
    keyFilter.appendChild(opt);
  });

  function renderFilteredRates() {
    const selectedOp = opFilter.value;
    const selectedKey = keyFilter.value;

    const filtered = allRates.filter(r =>
      (!selectedOp || r.operation === selectedOp) &&
      (!selectedKey || r.key === selectedKey)
    );

    const grouped = {};
    filtered.forEach(r => {
      if (!grouped[r.operation]) grouped[r.operation] = [];
      grouped[r.operation].push(r);
    });

    container.innerHTML = "";

    if (!Object.keys(grouped).length) {
      container.innerHTML = "<p style='text-align:center;'>Нет совпадений</p>";
      return;
    }

    Object.entries(grouped).forEach(([operation, entries]) => {
      const block = document.createElement("div");
      block.style.marginBottom = "20px";
      block.style.padding = "12px";
      block.style.border = "1px solid #ddd";
      block.style.borderRadius = "10px";
      block.style.backgroundColor = "#f9fafb";

      const title = document.createElement("h4");
      title.textContent = operation;
      title.style.color = "#1e40af";

      const list = document.createElement("ul");
      list.style.listStyle = "none";
      list.style.paddingLeft = "0";

      entries.forEach(e => {
        const item = document.createElement("li");
        item.className = "rate-item";
        item.innerHTML = `
          <span>📦 <strong>Объём:</strong> ${e.key}</span>
          <span>⏱ <strong>Норма:</strong> ${e.normPerHour} шт/час</span>
          <span>💰 <strong>Тариф:</strong> ${e.ratePerUnit.toFixed(2)} ₽/шт</span>
        `;
        list.appendChild(item);
      });

      block.appendChild(title);
      block.appendChild(list);
      container.appendChild(block);
    });
  }

  opFilter.onchange = renderFilteredRates;
  keyFilter.onchange = renderFilteredRates;

  renderFilteredRates(); // начальная отрисовка
}

async function loadOperationFilter() {
  const res = await fetch(`${scriptURL}?type=operations`);
  const data = await res.json();
  const filter = document.getElementById("operationFilter");

  filter.innerHTML = '<option value="">-- Все операции --</option>';
  data.operations.forEach(op => {
    const option = document.createElement("option");
    option.value = op;
    option.textContent = op;
    filter.appendChild(option);
  });
}

function openEditModal(index, record) {
  const form = document.getElementById("editForm");

  form.rowIndex.value = index;
  form.employeeName.value = currentUser;
  form.orderNumber.value = record.orderNumber || "";
  form.shiftType.value = currentShift;
  form.employeeStatus.value = currentStatus;

  form.quantity.value = record.quantity;
  form.startTime.value = record.startTime;
  form.endTime.value = record.endTime;

  document.getElementById("editOperation").value = record.operationType || "";
  document.getElementById("editVolumeSelect").value = record.volume || "";
  document.getElementById("editSetNumberSelect").value = record.setNumber || "";

  // триггерим отображение поля объёма/набора
  document.getElementById("editOperation").dispatchEvent(new Event("change"));

  document.getElementById("editModal").style.display = "block";
}

async function loadEditFormDictionaries() {
  // Операции
  const resOp = await fetch(`${scriptURL}?type=operations`);
  const operations = (await resOp.json()).operations || [];
  const opSelect = document.getElementById("editOperation");
  opSelect.innerHTML = '<option value="">-- Выбери операцию --</option>';
  operations.forEach(op => {
    const opt = document.createElement("option");
    opt.value = op;
    opt.textContent = op;
    opSelect.appendChild(opt);
  });

  // Объёмы
  const resVol = await fetch(`${scriptURL}?type=volumes`);
  const volumes = (await resVol.json()).volumes || [];
  const volSelect = document.getElementById("editVolumeSelect");
  volSelect.innerHTML = '<option value="">-- Выбери объём --</option>';
  volumes.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    volSelect.appendChild(opt);
  });

  // Артикулы наборов
  const resSet = await fetch(`${scriptURL}?type=sets`);
  const sets = (await resSet.json()).sets || [];
  const setSelect = document.getElementById("editSetNumberSelect");
  setSelect.innerHTML = '<option value="">-- Выбери артикул --</option>';
  sets.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    setSelect.appendChild(opt);
  });

  // Переключение объёма/набора
  opSelect.addEventListener("change", () => {
    const isSet = opSelect.value.includes("Сборка");
    document.getElementById("editVolumeLabel").style.display = isSet ? "none" : "block";
    volSelect.required = !isSet;
    document.getElementById("editSetNumberField").style.display = isSet ? "block" : "none";
  });
}

async function submitEditForm() {
  const form = document.getElementById("editForm");
  const formData = new FormData(form);
  const params = new URLSearchParams();

  formData.forEach((value, key) => {
    params.append(key, value);
  });

  // Устанавливаем флаг редактирования
  params.set("type", "editRecord");

  // 👇 Пересчёт длительности (важно!)
  const start = formData.get("startTime");
  const end = formData.get("endTime");
  if (start && end) {
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    let minutes = (eh * 60 + em) - (sh * 60 + sm);
    if (minutes < 0) minutes += 1440;
    const duration = `${Math.floor(minutes / 60)} ч ${minutes % 60} мин`;
    params.set("duration", duration);
  }

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      body: params,
    });

    const data = await res.json();
    if (data.status === "success") {
      alert(data.message || "Обновлено");
      closeEditModal();
      await loadStats();
    } else {
      alert(data.message || "Ошибка обновления");
    }
  } catch (err) {
    console.error("❌ Ошибка редактирования:", err);
    alert("Ошибка соединения: " + err.message);
  }
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}

function closeStats() {
  document.getElementById("statsCards").innerHTML = "";
  document.getElementById("totalWage").textContent = "";
  document.getElementById("statsLogs").innerHTML = "";

  const closeBtn = document.getElementById("closeStatsBtn");
  if (closeBtn) closeBtn.style.display = "none";
}

let isStatsLoading = false;

async function loadStats() {
  if (isStatsLoading) return;
  isStatsLoading = true;

  const showBtn = document.getElementById("showStatsBtn");
  if (showBtn) showBtn.disabled = true;

  try {
    const selectedOperation = document.getElementById("operationFilter").value;
    const date = document.getElementById("statsDate").value;

    if (!currentUser) {
      alert("❗Ошибка: пользователь не авторизован.");
      return;
    }

    // Очистка старого состояния
    closeStats();

    const res = await fetch(`${scriptURL}?type=stats&date=${encodeURIComponent(date)}&employee=${encodeURIComponent(currentUser)}`);
    const data = await res.json();

    const container = document.getElementById("statsCards");
    const totalElem = document.getElementById("totalWage");
    const logElem = document.getElementById("statsLogs");

    if (!data.records || !data.records.length) {
      container.innerHTML = '<p style="text-align:center;">Нет данных за выбранную дату</p>';
      return;
    }

    let totalWage = 0;
    let totalEfficiency = 0;
    let efficiencyCount = 0;

    const filtered = selectedOperation
      ? data.records.filter(r => r.operationType === selectedOperation)
      : data.records;

    filtered.forEach(rec => {
      const wage = rec.wage || 0;
      totalWage += wage;

      if (rec.efficiency !== null && rec.efficiency !== undefined) {
        totalEfficiency += rec.efficiency;
        efficiencyCount++;
      }

      const card = document.createElement("div");
      card.className = "stat-card";
      card.innerHTML = `
        <p><strong>🕒 Время:</strong> ${rec.startTime} – ${rec.endTime}</p>
        <p><strong>🔧 Операция:</strong> ${rec.operationType}</p>
        <p><strong>📦 Объём:</strong> ${rec.volume || "-"}</p>
        <p><strong>🧩 Набор:</strong> ${rec.setNumber || "-"}</p>
        <p><strong>🔢 Кол-во:</strong> ${rec.quantity}</p>
        <p><strong>⚙️ Эффективность:</strong> ${rec.efficiency ?? "-"}%</p>
        <p><strong>⏱ Норма в час:</strong> ${rec.normPerHour ?? "-"}</p>
        <p><strong>💰 Тариф за шт:</strong> ${rec.ratePerUnit?.toFixed(2) ?? "-"} ₽</p>
        <p><strong>💸 Заработано:</strong> ${wage.toFixed(2)} ₽</p>
      `;

      const today = new Date().toISOString().split("T")[0];
      if (rec.rowIndex !== undefined && date === today) {
        const editBtn = document.createElement("button");
        editBtn.textContent = "✏️ Редактировать";
        editBtn.onclick = () => openEditModal(rec.rowIndex, rec);
        card.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.textContent = "🗑 Удалить";
        delBtn.className = "danger";
        delBtn.style.marginLeft = "10px";
        delBtn.onclick = () => deleteRecord(rec.rowIndex);
        card.appendChild(delBtn);
      }

      container.appendChild(card);
    });

    const avgEff = efficiencyCount ? Math.round(totalEfficiency / efficiencyCount) : "-";
    totalElem.textContent = `💵 Всего: ${totalWage.toFixed(2)} ₽ | ⚙️ Средняя эффективность: ${avgEff}%`;

    if (selectedOperation) {
      totalElem.textContent += ` | Фильтр: ${selectedOperation}`;
    }

    if (data.logs && data.logs.length) {
      logElem.innerHTML = `
        <h4>🔍 Логи обработки:</h4>
        <pre style="font-size:13px; background:#f3f4f6; padding:10px; border-radius:8px; overflow-x:auto;">${data.logs.join('\n')}</pre>
      `;
    }

    // ✅ Показываем кнопку "❌ Закрыть"
    const closeBtn = document.getElementById("closeStatsBtn");
    if (closeBtn) closeBtn.style.display = "inline-block";

  } catch (error) {
    alert("❌ Ошибка загрузки статистики");
    console.error(error);
  } finally {
    isStatsLoading = false;
    if (showBtn) showBtn.disabled = false;
  }
}


window.addEventListener("DOMContentLoaded", async () => {
  await loadEditFormDictionaries();

  const savedUser = localStorage.getItem("currentUser");
  const savedRole = localStorage.getItem("currentUserRole");

  if (savedUser) {
    currentUser = savedUser;
    currentUserRole = savedRole || "user";

    if (currentUserRole === "admin") {
      document.getElementById("tabAdmin").style.display = "block";
    }

    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("tabContainer").style.display = "block";
    document.getElementById("profileContainer").style.display = "block";
    document.querySelector('[name="employeeName"]').value = currentUser;

    document.getElementById("bottomNav").style.display = "flex"; // 👈 показать нижнее меню

    await Promise.all([
      loadVolumes(),
      loadOperations(),
      loadSetNumbers(),
      loadTodayRecords(),
      loadOperationFilter(),
      loadRatesTable()
    ]);

    document.getElementById("operationFilter").addEventListener("change", loadStats);

    // 👉 Автообновление при выборе смены и статуса
    ["change", "input"].forEach(event =>
      ["shiftType", "employeeStatus"].forEach(id =>
        document.getElementById(id).addEventListener(event, saveProfile)
      )
    );

    // ⚡ Важное: вызываем в самом конце, чтобы подсказка точно показалась
    setTimeout(saveProfile, 0);
  } else {
    // 👇 Автофокус на поле логина, если пользователь не авторизован
    document.getElementById("login").focus();
  }
});


async function manualExport() {
  withLoading("exportBtn", async () => {
    const date = document.getElementById("unifiedStart").value;
    if (!date) {
      alert("⚠️ Укажите дату");
      return;
    }

    try {
      const res = await fetch(`${scriptURL}?type=exportNow&date=${encodeURIComponent(date)}`);
      const result = await res.text();
      alert(result || "✅ Экспорт завершён");
    } catch (err) {
      alert("❌ Ошибка экспорта: " + err.message);
    }
  });
}


async function runCustomReport() {
  withLoading("reportBtn", async () => {
    const start = document.getElementById("unifiedStart").value;
const end = document.getElementById("unifiedEnd").value;

    if (!start || !end) {
      alert("⚠️ Укажите начало и конец периода");
      return;
    }

    try {
      const res = await fetch(`${scriptURL}?type=weeklyReport&start=${start}&end=${end}`);
      const text = await res.text();

      alert(text || "✅ Отчёт успешно сформирован");
    } catch (err) {
      alert("❌ Ошибка при формировании отчёта: " + err.message);
    }
  });
}

async function analyzePackers() {
  withLoading("analyzeBtn", async () => {
    const start = document.getElementById("unifiedStart").value;
const end = document.getElementById("unifiedEnd").value;

    const output = document.getElementById("packerAnalysis");

    if (!start || !end) {
      output.innerHTML = "<p style='color:red;'>⚠️ Укажите обе даты</p>";
      return;
    }

    output.innerHTML = "⌛ Загружается...";

    try {
      const res = await fetch(`${scriptURL}?type=packerAnalytics&start=${start}&end=${end}`);
      const data = await res.json();

      if (!data.ok || !data.list || !data.list.length) {
        output.innerHTML = "<p>Нет данных за указанный период</p>";
        return;
      }

      const best = data.best || {};

      let html = "<table style='width:100%; border-collapse:collapse;'>";
      html += `
        <thead><tr style="background:#f3f4f6;">
          <th style="border:1px solid #ccc; padding:6px;">Сотрудник</th>
          <th style="border:1px solid #ccc; padding:6px;">Кол-во</th>
          <th style="border:1px solid #ccc; padding:6px;">Эффективность</th>
          <th style="border:1px solid #ccc; padding:6px;">Зарплата</th>
        </tr></thead><tbody>
      `;

      data.list.forEach(row => {
        html += `
          <tr>
            <td style="border:1px solid #ccc; padding:6px;">${row.name}</td>
            <td style="border:1px solid #ccc; padding:6px;">${row.qty}</td>
            <td style="border:1px solid #ccc; padding:6px;">${row.efficiency}%</td>
            <td style="border:1px solid #ccc; padding:6px;">${row.wage.toFixed(2)} ₽</td>
          </tr>
        `;
      });

      html += "</tbody></table>";

      if (best.name) {
        html += `<p style="margin-top:12px;"><strong>🏆 Лучший упаковщик:</strong> ${best.name} (${best.qty} шт, ${best.efficiency}% эффективность)</p>`;
      }

      output.innerHTML = html;
    } catch (err) {
      output.innerHTML = `<p style="color:red;">Ошибка: ${err.message}</p>`;
    }
  });
}

async function withLoading(buttonId, asyncCallback) {
  const btn = document.getElementById(buttonId);
  if (!btn) return;

  btn.classList.add("button-loading");
  btn.disabled = true;

  try {
    await asyncCallback();
  } catch (err) {
    console.error("Ошибка:", err);
    throw err;
  } finally {
    btn.classList.remove("button-loading");
    btn.disabled = false;
  }
}

async function loadShiftStats() {
  const date = document.getElementById("unifiedStart").value;
  const container = document.getElementById("shiftStatsOutput");
  container.innerHTML = "";

  if (!date) {
    container.innerHTML = "<p style='color:red;'>⚠️ Укажите дату</p>";
    return;
  }

  try {
    const res = await fetch(`${scriptURL}?type=shiftStats&date=${encodeURIComponent(date)}`);
    const data = await res.json();

    if (!data || !data.data || !data.data.length) {
      container.innerHTML = "<p style='text-align:center;'>Нет данных по выбранной дате</p>";
      return;
    }

    data.data.forEach(group => {
      const table = document.createElement("table");
      table.style.width = "100%";
      table.style.marginTop = "16px";
      table.style.borderCollapse = "collapse";

      const caption = document.createElement("caption");
      caption.textContent = `🕐 Смена: ${group.shift}`;
      caption.style.fontWeight = "bold";
      caption.style.marginBottom = "8px";
      table.appendChild(caption);

      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr style="background:#f3f4f6;">
          <th style="padding:6px; border:1px solid #ccc;">Сотрудник</th>
          <th style="padding:6px; border:1px solid #ccc;">Кол-во</th>
          <th style="padding:6px; border:1px solid #ccc;">Эффективность</th>
          <th style="padding:6px; border:1px solid #ccc;">Зарплата</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      group.employees.forEach(e => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="padding:6px; border:1px solid #ccc;">${e.name}</td>
          <td style="padding:6px; border:1px solid #ccc;">${e.quantity}</td>
          <td style="padding:6px; border:1px solid #ccc;">${e.efficiency}%</td>
          <td style="padding:6px; border:1px solid #ccc;">${e.wage.toFixed(2)} ₽</td>
        `;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);

      const totalQty = group.employees.reduce((sum, e) => sum + e.quantity, 0);
      const totalWage = group.employees.reduce((sum, e) => sum + e.wage, 0);
      const avgEff = Math.round(
        group.employees.reduce((sum, e) => sum + e.efficiency, 0) / group.employees.length
      );

      const summary = document.createElement("div");
      summary.style.marginTop = "8px";
      summary.style.padding = "8px";
      summary.style.background = "#fef3c7";
      summary.style.borderRadius = "6px";
      summary.style.fontWeight = "bold";
      summary.textContent = `📊 Итого: 🔢 ${totalQty} шт | ⚙️ ${avgEff}% | 💰 ${totalWage.toFixed(2)} ₽`;

      container.appendChild(summary);
    });
  } catch (err) {
    container.innerHTML = "<p style='color:red;'>Ошибка загрузки: " + err.message + "</p>";
  }
}

// 📡 Проверка подключения к интернету
window.addEventListener('offline', () => {
  alert('📡 Нет подключения к интернету');
});
window.addEventListener('online', () => {
  alert('✅ Соединение восстановлено');
});
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('✅ Service Worker зарегистрирован:', reg.scope))
        .catch(err => console.error('❌ Ошибка регистрации SW:', err));
    });
  }

// ⏱ Автофокус при загрузке
window.addEventListener("DOMContentLoaded", () => {
  const loginInput = document.getElementById("login");
  if (loginInput) loginInput.focus();
});

// 🧼 Сброс ошибки при вводе
["login", "password"].forEach(id => {
  const input = document.getElementById(id);
  if (input) {
    input.addEventListener("input", () => {
      const error = document.getElementById("loginError");
      if (error) error.textContent = "";
    });
  }
});

// ⏎ Вход по нажатию Enter
document.getElementById("password").addEventListener("keydown", e => {
  if (e.key === "Enter") {
    handleLogin();
  }
});

</script>
<div id="editModal" style="display:none; position:fixed; top:10%; left:0; right:0; margin:auto; max-width:500px; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 12px rgba(0,0,0,0.3); z-index:1000;">
  <h3>✏️ Редактировать запись</h3>
  <form id="editForm">
  <input type="hidden" name="rowIndex" />
  <input type="hidden" name="employeeName" />
  <input type="hidden" name="orderNumber" />
  <input type="hidden" name="shiftType" />
  <input type="hidden" name="employeeStatus" />
  <input type="hidden" name="duration" />

  <label>Операция:
    <select name="operationType" id="editOperation" required></select>
  </label>

  <label id="editVolumeLabel">Объём:
    <select name="volume" id="editVolumeSelect"></select>
  </label>

  <div id="editSetNumberField" style="display:none;">
    <label>Артикул набора:
      <select name="setNumber" id="editSetNumberSelect"></select>
    </label>
  </div>

  <label>Количество:<input name="quantity" type="number" required /></label>
  <label>Начало:<input name="startTime" type="time" required /></label>
  <label>Окончание:<input name="endTime" type="time" required /></label>

  <button type="button" onclick="submitEditForm()">💾 Сохранить</button>
  <button type="button" onclick="closeEditModal()" class="danger">❌ Отмена</button>
</form>
</div>
</body>
</html>
